<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CSC316 - Final Project</title>

	<!-- Load CSS libraries -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="css/style.css">
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,400italic,300italic' rel='stylesheet' type='text/css'>
	<link href='https://fonts.googleapis.com/css?family=Satisfy' rel='stylesheet' type='text/css'>
  
	<!-- Rating comparison styles -->
	<style>
		.chart-container {
			position: relative;
		}
		.line {
			fill: none;
			stroke-width: 2.5;
		}
		.line-167084 {
			stroke: #2b83ba;
		}
		.line-132534 {
			stroke: #d7191c;
		}
		.axis-label {
			font-size: 12px;
			text-anchor: middle;
		}
		.rating-tooltip {
			position: absolute;
			padding: 8px;
			background: rgba(0, 0, 0, 0.7);
			color: white;
			border-radius: 4px;
			pointer-events: none;
			font-size: 12px;
		}
		.legend {
			display: flex;
			justify-content: center;
			margin-bottom: 20px;
		}
		.legend-item {
			display: flex;
			align-items: center;
			margin: 0 15px;
		}
		.legend-color {
			width: 20px;
			height: 10px;
			margin-right: 5px;
		}
		.axis path,
		.axis line {
			stroke: #888;
		}
		.axis text {
			fill: #333;
		}
		.grid line {
			stroke: #e0e0e0;
			stroke-opacity: 0.7;
		}
		.brush .selection {
			fill: #69b3a2;
			fill-opacity: 0.2;
			stroke: #2a7b9b;
		}
		.context-chart {
			margin-top: 15px;
		}
		.reset-button {
			margin: 10px auto;
			display: block;
			padding: 6px 12px;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}
		.reset-button:hover {
			background-color: #45a049;
		}
		.reset-button:disabled {
			background-color: #cccccc;
			cursor: not-allowed;
		}
		.hidden {
			display: none;
		}
	</style>
</head>
<body>

	<div id="fullpage">
		<div class="section">Some section
		<div class="container">
			<div class="row text-center">
				<div class="col-2"> </div>

				<!-- create column of size 8 -->
				<div class="col-8">
					<div class="row-sm-4">
						<h2>Canadian Chess Visualization</h2>
						<h1>Global Attractions Attendance</h1>
					</div>

					<div class="row" >
						<div class="col-sm-4"></div>
						<div class="col-sm-4 text-center user-control">
							<div class="form-group">
								<label for="attraction-category">Choose Category:</label>
									<select id="attraction-category" class="form-control" onchange="updateChart()">
										<option value="all">All Attractions</option>
										<option value="Water Park">Water Park</option>
										<option value="Museum">Museum</option>
										<option value="Theme Park">Theme Park</option>
									</select>
							</div>
						</div>
						<div class="col-sm-4"></div>
					</div>
					<div class="row" style="background: #e0e4e8">
						<div class="col">
							<div id="chart-area"></div>
						</div>
					</div>
				</div>
				<div class="col-sm-2"></div>
			</div>
		</div>
	</div>
	
	<div class="section">
		<div class="container">
			<div class="row text-center">
				<div class="col-12">
					<h2>Canadian National Chess Masters</h2>
					<p>Visualization of when players achieved their National Master titles over time</p>
					<div id="masters-visualization" class="mt-4"></div>
					<!-- Add tooltip container -->
					<div id="masters-tooltip" class="hidden">
						<p><span id="masters-value"></span></p>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<div class="section">
		<div class="container">
			<div class="row text-center">
				<div class="col-12">
					<h2>Player Rating Comparison</h2>
					<p>Compare the rating progression of two chess players over time</p>
					
					<div class="controls mt-4">
						<select id="yAxisType">
							<option value="fixed">Fixed Y-Axis Scale</option>
							<option value="dynamic">Dynamic Y-Axis Scale</option>
						</select>
						<select id="smoothing">
							<option value="0">No Smoothing</option>
							<option value="1">Light Smoothing</option>
							<option value="2" selected>Medium Smoothing</option>
							<option value="3">Heavy Smoothing</option>
						</select>
					</div>
					
					<div class="legend">
						<div class="legend-item">
							<div class="legend-color" style="background-color: #2b83ba;"></div>
							<span>Player 167084</span>
						</div>
						<div class="legend-item">
							<div class="legend-color" style="background-color: #d7191c;"></div>
							<span>Player 132534</span>
						</div>
					</div>
					
					<div class="chart-container">
						<div id="chart"></div>
						<div id="rating-tooltip" class="rating-tooltip hidden"></div>
					</div>
					
					<button id="resetZoom" class="reset-button" disabled>Reset Zoom</button>
					
					<div class="context-chart">
						<div id="context"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="section">Some section</div>
	<div class="section">Some section</div>
	<div class="section">Some section</div>
</div>

<!-- d3 - update to v7 for rating comparison -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<!-- Load d3-cloud -->
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>

<!-- Fullpage Stepper -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullPage.js/3.0.9/fullpage.js"></script>
	<!-- <script src="
	https://cdn.jsdelivr.net/npm/fullpage.js@4.0.34/dist/fullpage.min.js
	"></script> -->

<!-- Slick Carousel -->
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
<script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="js/slick/slick.min.js"></script>

<!-- Completed: data loading, bar-chart rendering -->
<script src="js/global-attractions.js"></script>
<script src="js/barchart.js"></script>

<!-- National Masters Visualization -->
<script src="js/masters-timeline.js"></script>

<!-- TODO: Add your activity_2.js file -->
<script src="js/activity_2.js"></script>
<script src="js/activity_3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<!-- Initialize Fullpage stepper-->
<script>
    new fullpage('#fullpage', {
        // options here
        anchors: ['Home', 'Masters', 'Ratings', '3rdPage', '4thPage', '5thPage', '6thPage', '7thPage', '8thPage', '9thPage', '10thPage', 'AboutUs', 'Sources'],
        // autoScrolling false because story boxes need vertical scrolling
        autoScrolling: false,
        scrollingSpeed: 500,
        scrollHorizontally: false,
        onLeave: function(origin, destination){
            destination.item.classList.add('load-background');
        },
        slidesNavigation: true,
        navigation: true,
        navigationPosition: 'right',
    });
</script>

<!-- Add the rating comparison script -->
<script>
	// This script runs after DOM is fully loaded
	document.addEventListener('DOMContentLoaded', function() {
		// Load both CSV files
		Promise.all([
			d3.csv('data/rating_history_167084.csv'),
			d3.csv('data/rating_history_132534.csv')
		]).then(function(data) {
			const player1Data = data[0];
			const player2Data = data[1];
			
			// Process the data
			function processData(data, playerId) {
				return data.map(d => {
					return {
						eventId: d.eventId,
						eventDate: new Date(d.eventDate),
						eventName: d.eventName,
						eventLocation: d.eventLocation || "",
						score: d.score,
						ratingPerf: +d.ratingPerf,
						ratingPost: +d.ratingPost,
						playerId: playerId
					};
				}).sort((a, b) => a.eventDate - b.eventDate);
			}
			
			const processedPlayer1 = processData(player1Data, "167084");
			const processedPlayer2 = processData(player2Data, "132534");
			
			// Combine data for domain calculations
			const allData = [...processedPlayer1, ...processedPlayer2];
			
			// Define time domain
			const timeDomain = [
				d3.min(allData, d => d.eventDate),
				d3.max(allData, d => d.eventDate)
			];
			
			// Create the chart with initial full domain
			createCharts(processedPlayer1, processedPlayer2, timeDomain);
			
			function createCharts(data1, data2, xDomain) {
				// Clear the chart containers
				d3.select("#chart").html("");
				d3.select("#context").html("");
				
				// Set dimensions and margins for main chart
				const margin = {top: 40, right: 80, bottom: 60, left: 80};
				const width = Math.min(1100, window.innerWidth - 100) - margin.left - margin.right;
				const height = 500 - margin.top - margin.bottom;
				
				// Set dimensions and margins for context chart (brush)
				const marginContext = {top: 20, right: 80, bottom: 30, left: 80};
				const heightContext = 100 - marginContext.top - marginContext.bottom;
				
				// Create SVG for main chart
				const svg = d3.select("#chart")
					.append("svg")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom)
					.append("g")
						.attr("transform", `translate(${margin.left},${margin.top})`);
				
				// Create SVG for context chart
				const svgContext = d3.select("#context")
					.append("svg")
						.attr("width", width + marginContext.left + marginContext.right)
						.attr("height", heightContext + marginContext.top + marginContext.bottom)
					.append("g")
						.attr("transform", `translate(${marginContext.left},${marginContext.top})`);
				
				// Scale for X axis (time) - main chart
				const xScale = d3.scaleTime()
					.domain(xDomain)
					.range([0, width]);
				
				// Scale for X axis (time) - context chart (always full domain)
				const xScaleContext = d3.scaleTime()
					.domain(timeDomain)
					.range([0, width]);
				
				// Scale for Y axis (rating) - main chart
				const yAxisType = document.getElementById("yAxisType").value;
				const yScale = d3.scaleLinear()
					.domain(yAxisType === "fixed" ? 
						[800, 2700] : 
						[
							d3.min(allData, d => d.ratingPost) - 50,
							d3.max(allData, d => d.ratingPost) + 50
						]
					)
					.range([height, 0]);
				
				// Scale for Y axis (rating) - context chart (always full domain)
				const yScaleContext = d3.scaleLinear()
					.domain([800, 2700])
					.range([heightContext, 0]);
				
				// Add X axis - main chart
				svg.append("g")
					.attr("class", "axis")
					.attr("transform", `translate(0,${height})`)
					.call(d3.axisBottom(xScale)
						.tickFormat(d3.timeFormat("%Y-%m"))
						.ticks(10));
				
				// Add X axis label - main chart
				svg.append("text")
					.attr("class", "axis-label")
					.attr("x", width / 2)
					.attr("y", height + 40)
					.text("Date");
				
				// Add Y axis - main chart
				svg.append("g")
					.attr("class", "axis")
					.call(d3.axisLeft(yScale));
				
				// Add Y axis label - main chart
				svg.append("text")
					.attr("class", "axis-label")
					.attr("transform", "rotate(-90)")
					.attr("x", -height / 2)
					.attr("y", -60)
					.text("Rating");
				
				// Add horizontal grid lines - main chart
				svg.append("g")
					.attr("class", "grid")
					.call(d3.axisLeft(yScale)
						.tickSize(-width)
						.tickFormat(""));
				
				// Define smoothing factor
				const smoothingFactor = +document.getElementById("smoothing").value;
				
				// Create line generators - main chart
				const line = d3.line()
					.x(d => xScale(d.eventDate))
					.y(d => yScale(d.ratingPost));
					
				if (smoothingFactor > 0) {
					line.curve(d3.curveMonotoneX);
				}
				
				// Create line generators - context chart
				const lineContext = d3.line()
					.x(d => xScaleContext(d.eventDate))
					.y(d => yScaleContext(d.ratingPost))
					.curve(d3.curveMonotoneX);
				
				// Add line for player 1 - main chart
				svg.append("path")
					.datum(data1)
					.attr("class", "line line-167084")
					.attr("d", line);
				
				// Add line for player 2 - main chart
				svg.append("path")
					.datum(data2)
					.attr("class", "line line-132534")
					.attr("d", line);
				
				// Add line for player 1 - context chart
				svgContext.append("path")
					.datum(processedPlayer1)
					.attr("class", "line line-167084")
					.attr("d", lineContext);
				
				// Add line for player 2 - context chart
				svgContext.append("path")
					.datum(processedPlayer2)
					.attr("class", "line line-132534")
					.attr("d", lineContext);
				
				// Add dots for player 1 - main chart
				svg.selectAll(".dot-167084")
					.data(data1)
					.enter()
					.append("circle")
						.attr("class", "dot-167084")
						.attr("cx", d => xScale(d.eventDate))
						.attr("cy", d => yScale(d.ratingPost))
						.attr("r", 4)
						.attr("fill", "#2b83ba")
						.on("mouseover", function(event, d) {
							showTooltip(event, d);
						})
						.on("mouseout", function() {
							hideTooltip();
						});
				
				// Add dots for player 2 - main chart
				svg.selectAll(".dot-132534")
					.data(data2)
					.enter()
					.append("circle")
						.attr("class", "dot-132534")
						.attr("cx", d => xScale(d.eventDate))
						.attr("cy", d => yScale(d.ratingPost))
						.attr("r", 4)
						.attr("fill", "#d7191c")
						.on("mouseover", function(event, d) {
							showTooltip(event, d);
						})
						.on("mouseout", function() {
							hideTooltip();
						});
				
				// Add X axis - context chart
				svgContext.append("g")
					.attr("class", "axis")
					.attr("transform", `translate(0,${heightContext})`)
					.call(d3.axisBottom(xScaleContext)
						.tickFormat(d3.timeFormat("%Y"))
						.ticks(6));
				
				// Add brush to context chart
				const brush = d3.brushX()
					.extent([[0, 0], [width, heightContext]])
					.on("end", brushed);
				
				svgContext.append("g")
					.attr("class", "brush")
					.call(brush);
				
				// Brush function - updates main chart when brush is used
				function brushed(event) {
					if (!event.selection) return;
					
					// Get the selected time range from the brush
					const [x0, x1] = event.selection.map(xScaleContext.invert);
					
					// Enable reset button
					d3.select("#resetZoom").property("disabled", false);
					
					// Filter data to show only what's in the brushed range
					const filteredData1 = processedPlayer1.filter(d => d.eventDate >= x0 && d.eventDate <= x1);
					const filteredData2 = processedPlayer2.filter(d => d.eventDate >= x0 && d.eventDate <= x1);
					
					// Update the main chart with the filtered data and new domain
					createCharts(filteredData1, filteredData2, [x0, x1]);
				}
				
				// Reset zoom button functionality
				d3.select("#resetZoom").on("click", function() {
					d3.select(this).property("disabled", true);
					createCharts(processedPlayer1, processedPlayer2, timeDomain);
				});
			}
			
			// Add tooltip functionality
			function showTooltip(event, d) {
				const tooltip = d3.select("#rating-tooltip");
				
				tooltip
					.classed("hidden", false)
					.style("left", (event.pageX + 10) + "px")
					.style("top", (event.pageY - 20) + "px")
					.html(`
						<strong>Player:</strong> ${d.playerId}<br>
						<strong>Date:</strong> ${d.eventDate.toISOString().split('T')[0]}<br>
						<strong>Event:</strong> ${d.eventName}<br>
						<strong>Location:</strong> ${d.eventLocation}<br>
						<strong>Score:</strong> ${d.score}<br>
						<strong>Performance:</strong> ${d.ratingPerf}<br>
						<strong>Rating After:</strong> ${d.ratingPost}
					`);
			}
			
			function hideTooltip() {
				d3.select("#rating-tooltip").classed("hidden", true);
			}
			
			// Add event listeners to controls
			document.getElementById("yAxisType").addEventListener("change", function() {
				// Get current zoom state
				const resetDisabled = d3.select("#resetZoom").property("disabled");
				if (resetDisabled) {
					// Full view
					createCharts(processedPlayer1, processedPlayer2, timeDomain);
				} else {
					// We're zoomed in, need to get current x domain
					const svg = d3.select("#chart svg");
					const xScale = d3.scaleTime();
					const domain = xScale.domain(); // Current domain of the zoomed view
					
					// Filter data based on current view
					const filteredData1 = processedPlayer1.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
					const filteredData2 = processedPlayer2.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
					
					createCharts(filteredData1, filteredData2, domain);
				}
			});
			
			document.getElementById("smoothing").addEventListener("change", function() {
				// Similar logic to yAxisType change handler
				const resetDisabled = d3.select("#resetZoom").property("disabled");
				if (resetDisabled) {
					createCharts(processedPlayer1, processedPlayer2, timeDomain);
				} else {
					const svg = d3.select("#chart svg");
					const xScale = d3.scaleTime();
					const domain = xScale.domain();
					
					const filteredData1 = processedPlayer1.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
					const filteredData2 = processedPlayer2.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
					
					createCharts(filteredData1, filteredData2, domain);
				}
			});
		}).catch(function(error) {
			console.log("Error loading CSV files:", error);
		});
	});
</script>

</body>
</html>