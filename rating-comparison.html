<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess Rating History Comparison</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .chart-container {
      position: relative;
    }
    .line {
      fill: none;
      stroke-width: 2.5;
    }
    .line-167084 {
      stroke: #2b83ba;
    }
    .line-132534 {
      stroke: #d7191c;
    }
    .axis-label {
      font-size: 12px;
      text-anchor: middle;
    }
    .tooltip {
      position: absolute;
      padding: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
    }
    .legend {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin: 0 15px;
    }
    .legend-color {
      width: 20px;
      height: 10px;
      margin-right: 5px;
    }
    .controls {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    .controls select {
      margin: 0 10px;
      padding: 5px;
    }
    .player-details {
      margin-top: 30px;
      padding: 15px;
      background-color: #f0f0f0;
      border-radius: 5px;
    }
    .axis path,
    .axis line {
      stroke: #888;
    }
    .axis text {
      fill: #333;
    }
    .grid line {
      stroke: #e0e0e0;
      stroke-opacity: 0.7;
    }
    .brush .selection {
      fill: #69b3a2;
      fill-opacity: 0.2;
      stroke: #2a7b9b;
    }
    .context-chart {
      margin-top: 15px;
    }
    .reset-button {
      margin: 10px auto;
      display: block;
      padding: 6px 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .reset-button:hover {
      background-color: #45a049;
    }
    .reset-button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Chess Rating History Comparison</h1>
    
    <div class="controls">
      <select id="yAxisType">
        <option value="fixed">Fixed Y-Axis Scale</option>
        <option value="dynamic">Dynamic Y-Axis Scale</option>
      </select>
      <select id="smoothing">
        <option value="0">No Smoothing</option>
        <option value="1">Light Smoothing</option>
        <option value="2" selected>Medium Smoothing</option>
        <option value="3">Heavy Smoothing</option>
      </select>
    </div>
    
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background-color: #2b83ba;"></div>
        <span>Player 167084</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background-color: #d7191c;"></div>
        <span>Player 132534</span>
      </div>
    </div>
    
    <div class="chart-container">
      <div id="chart"></div>
      <div id="tooltip" class="tooltip" style="display: none;"></div>
    </div>
    
    <button id="resetZoom" class="reset-button" disabled>Reset Zoom</button>
    
    <div class="context-chart">
      <div id="context"></div>
    </div>
    
    <div class="player-details">
      <h3>Player Information</h3>
      <p>This chart displays the rating progress over time for two chess players:</p>
      <ul>
        <li><strong>Player 167084:</strong> A rapidly improving young player</li>
        <li><strong>Player 132534:</strong> An established player with a longer history</li>
      </ul>
      <p>Hover over points on the chart to see details about specific tournaments.</p>
      <p><strong>New feature:</strong> Select a region on the smaller chart below to zoom in. Use the Reset Zoom button to return to the full view.</p>
    </div>
  </div>

  <script>
    // Load both CSV files
    Promise.all([
      d3.csv('data/rating_history_167084.csv'),
      d3.csv('data/rating_history_132534.csv')
    ]).then(function(data) {
      const player1Data = data[0];
      const player2Data = data[1];
      
      // Process the data
      function processData(data, playerId) {
        return data.map(d => {
          return {
            eventId: d.eventId,
            eventDate: new Date(d.eventDate),
            eventName: d.eventName,
            eventLocation: d.eventLocation || "",
            score: d.score,
            ratingPerf: +d.ratingPerf,
            ratingPost: +d.ratingPost,
            playerId: playerId
          };
        }).sort((a, b) => a.eventDate - b.eventDate);
      }
      
      const processedPlayer1 = processData(player1Data, "167084");
      const processedPlayer2 = processData(player2Data, "132534");
      
      // Combine data for domain calculations
      const allData = [...processedPlayer1, ...processedPlayer2];
      
      // Define time domain
      const timeDomain = [
        d3.min(allData, d => d.eventDate),
        d3.max(allData, d => d.eventDate)
      ];
      
      // Create the chart with initial full domain
      createCharts(processedPlayer1, processedPlayer2, timeDomain);
      
      function createCharts(data1, data2, xDomain) {
        // Clear the chart containers
        d3.select("#chart").html("");
        d3.select("#context").html("");
        
        // Set dimensions and margins for main chart
        const margin = {top: 40, right: 80, bottom: 60, left: 80};
        const width = 1100 - margin.left - margin.right;
        const height = 500 - margin.top - margin.bottom;
        
        // Set dimensions and margins for context chart (brush)
        const marginContext = {top: 20, right: 80, bottom: 30, left: 80};
        const heightContext = 100 - marginContext.top - marginContext.bottom;
        
        // Create SVG for main chart
        const svg = d3.select("#chart")
          .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        
        // Create SVG for context chart
        const svgContext = d3.select("#context")
          .append("svg")
            .attr("width", width + marginContext.left + marginContext.right)
            .attr("height", heightContext + marginContext.top + marginContext.bottom)
          .append("g")
            .attr("transform", `translate(${marginContext.left},${marginContext.top})`);
        
        // Scale for X axis (time) - main chart
        const xScale = d3.scaleTime()
          .domain(xDomain)
          .range([0, width]);
        
        // Scale for X axis (time) - context chart (always full domain)
        const xScaleContext = d3.scaleTime()
          .domain(timeDomain)
          .range([0, width]);
        
        // Scale for Y axis (rating) - main chart
        const yAxisType = document.getElementById("yAxisType").value;
        const yScale = d3.scaleLinear()
          .domain(yAxisType === "fixed" ? 
            [800, 2700] : 
            [
              d3.min(allData, d => d.ratingPost) - 50,
              d3.max(allData, d => d.ratingPost) + 50
            ]
          )
          .range([height, 0]);
        
        // Scale for Y axis (rating) - context chart (always full domain)
        const yScaleContext = d3.scaleLinear()
          .domain([800, 2700])
          .range([heightContext, 0]);
        
        // Add X axis - main chart
        svg.append("g")
          .attr("class", "axis")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(xScale)
            .tickFormat(d3.timeFormat("%Y-%m"))
            .ticks(10));
        
        // Add X axis label - main chart
        svg.append("text")
          .attr("class", "axis-label")
          .attr("x", width / 2)
          .attr("y", height + 40)
          .text("Date");
        
        // Add Y axis - main chart
        svg.append("g")
          .attr("class", "axis")
          .call(d3.axisLeft(yScale));
        
        // Add Y axis label - main chart
        svg.append("text")
          .attr("class", "axis-label")
          .attr("transform", "rotate(-90)")
          .attr("x", -height / 2)
          .attr("y", -60)
          .text("Rating");
        
        // Add horizontal grid lines - main chart
        svg.append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(yScale)
            .tickSize(-width)
            .tickFormat(""));
        
        // Define smoothing factor
        const smoothingFactor = +document.getElementById("smoothing").value;
        
        // Create line generators - main chart
        const line = d3.line()
          .x(d => xScale(d.eventDate))
          .y(d => yScale(d.ratingPost));
          
        if (smoothingFactor > 0) {
          line.curve(d3.curveMonotoneX);
        }
        
        // Create line generators - context chart
        const lineContext = d3.line()
          .x(d => xScaleContext(d.eventDate))
          .y(d => yScaleContext(d.ratingPost))
          .curve(d3.curveMonotoneX);
        
        // Add line for player 1 - main chart
        svg.append("path")
          .datum(data1)
          .attr("class", "line line-167084")
          .attr("d", line);
        
        // Add line for player 2 - main chart
        svg.append("path")
          .datum(data2)
          .attr("class", "line line-132534")
          .attr("d", line);
        
        // Add line for player 1 - context chart
        svgContext.append("path")
          .datum(processedPlayer1)
          .attr("class", "line line-167084")
          .attr("d", lineContext);
        
        // Add line for player 2 - context chart
        svgContext.append("path")
          .datum(processedPlayer2)
          .attr("class", "line line-132534")
          .attr("d", lineContext);
        
        // Add dots for player 1 - main chart
        svg.selectAll(".dot-167084")
          .data(data1)
          .enter()
          .append("circle")
            .attr("class", "dot-167084")
            .attr("cx", d => xScale(d.eventDate))
            .attr("cy", d => yScale(d.ratingPost))
            .attr("r", 4)
            .attr("fill", "#2b83ba")
            .on("mouseover", function(event, d) {
              showTooltip(event, d);
            })
            .on("mouseout", function() {
              hideTooltip();
            });
        
        // Add dots for player 2 - main chart
        svg.selectAll(".dot-132534")
          .data(data2)
          .enter()
          .append("circle")
            .attr("class", "dot-132534")
            .attr("cx", d => xScale(d.eventDate))
            .attr("cy", d => yScale(d.ratingPost))
            .attr("r", 4)
            .attr("fill", "#d7191c")
            .on("mouseover", function(event, d) {
              showTooltip(event, d);
            })
            .on("mouseout", function() {
              hideTooltip();
            });
        
        // Add X axis - context chart
        svgContext.append("g")
          .attr("class", "axis")
          .attr("transform", `translate(0,${heightContext})`)
          .call(d3.axisBottom(xScaleContext)
            .tickFormat(d3.timeFormat("%Y"))
            .ticks(6));
        
        // Add brush to context chart
        const brush = d3.brushX()
          .extent([[0, 0], [width, heightContext]])
          .on("end", brushed);
        
        svgContext.append("g")
          .attr("class", "brush")
          .call(brush);
        
        // Brush function - updates main chart when brush is used
        function brushed(event) {
          if (!event.selection) return;
          
          // Get the selected time range from the brush
          const [x0, x1] = event.selection.map(xScaleContext.invert);
          
          // Enable reset button
          d3.select("#resetZoom").property("disabled", false);
          
          // Filter data to show only what's in the brushed range
          const filteredData1 = processedPlayer1.filter(d => d.eventDate >= x0 && d.eventDate <= x1);
          const filteredData2 = processedPlayer2.filter(d => d.eventDate >= x0 && d.eventDate <= x1);
          
          // Update the main chart with the filtered data and new domain
          createCharts(filteredData1, filteredData2, [x0, x1]);
        }
        
        // Reset zoom button functionality
        d3.select("#resetZoom").on("click", function() {
          d3.select(this).property("disabled", true);
          createCharts(processedPlayer1, processedPlayer2, timeDomain);
        });
      }
      
      // Add tooltip functionality
      function showTooltip(event, d) {
        const tooltip = d3.select("#tooltip");
        
        tooltip
          .style("display", "block")
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 20) + "px")
          .html(`
            <strong>Player:</strong> ${d.playerId}<br>
            <strong>Date:</strong> ${d.eventDate.toISOString().split('T')[0]}<br>
            <strong>Event:</strong> ${d.eventName}<br>
            <strong>Location:</strong> ${d.eventLocation}<br>
            <strong>Score:</strong> ${d.score}<br>
            <strong>Performance:</strong> ${d.ratingPerf}<br>
            <strong>Rating After:</strong> ${d.ratingPost}
          `);
      }
      
      function hideTooltip() {
        d3.select("#tooltip").style("display", "none");
      }
      
      // Add event listeners to controls
      document.getElementById("yAxisType").addEventListener("change", function() {
        // Get current zoom state
        const resetDisabled = d3.select("#resetZoom").property("disabled");
        if (resetDisabled) {
          // Full view
          createCharts(processedPlayer1, processedPlayer2, timeDomain);
        } else {
          // We're zoomed in, need to get current x domain
          const svg = d3.select("#chart svg");
          const xScale = d3.scaleTime();
          const domain = xScale.domain(); // Current domain of the zoomed view
          
          // Filter data based on current view
          const filteredData1 = processedPlayer1.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
          const filteredData2 = processedPlayer2.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
          
          createCharts(filteredData1, filteredData2, domain);
        }
      });
      
      document.getElementById("smoothing").addEventListener("change", function() {
        // Similar logic to yAxisType change handler
        const resetDisabled = d3.select("#resetZoom").property("disabled");
        if (resetDisabled) {
          createCharts(processedPlayer1, processedPlayer2, timeDomain);
        } else {
          const svg = d3.select("#chart svg");
          const xScale = d3.scaleTime();
          const domain = xScale.domain();
          
          const filteredData1 = processedPlayer1.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
          const filteredData2 = processedPlayer2.filter(d => d.eventDate >= domain[0] && d.eventDate <= domain[1]);
          
          createCharts(filteredData1, filteredData2, domain);
        }
      });
    }).catch(function(error) {
      console.log("Error loading CSV files:", error);
    });
  </script>
</body>
</html>
